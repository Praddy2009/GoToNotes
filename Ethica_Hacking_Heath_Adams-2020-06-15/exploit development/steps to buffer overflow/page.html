<!DOCTYPE html  PUBLIC '-//W3C//DTD XHTML 1.0 Transitional//EN'  'http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd'><html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<title>Steps to Buffer Overflow</title>
</head><body><br/>
Prerequisites:<br/>
&gt; A malicious program installed and running as administrator on target machine (here Vulnserver)<br/>
&gt; Immunity debugger installed and running as administrator on target machine <br/>
&gt; Real time protection off on target machine<br/>
<br/>
Step 1: open Debugger and File&gt;Attach&gt;vulnserver&gt;Attach<br/>
<br/>
<img src="image.png"/><br/>
<br/>
<br/>
Step 2) Run it<br/>
<br/>
<img src="image 2.png"/><br/>
<br/>
Note : Vulnserver runs on 9999 port by defaylt <br/>
<br/>
Step 3: Connect to vulnserver via netcat<br/>
<br/>
nc -nv &lt;ip address of machine&gt; &lt;port&gt;<br/>
<br/>
<img src="image 3.png"/><br/>
<br/>
Now here we got different commands<br/>
<br/>
<img src="image 4.png"/><br/>
<hr/><br/>
<span style="font-size: 15pt"><b>1) Spiking<br/>
<br/>
</b></span><span style="font-size: 13pt">We'll do spiking on each command</span><b><span style="font-size: 15pt"><br/>
</span></b><span style="font-size: 12pt">So to do spiking we need to use <b>generic_send_tcp<br/>
</b><b><br/>
</b></span><b><img src="image 5.png"/><br/>
<br/>
</b>So we need to create spike_script<br/>
<br/>
stats.spk<br/>
<br/>
<img src="image 6.png"/><br/>
<br/>
<span style="font-size: 12pt">Here we are going to read the lines and take the string with STATS and send variable 0 in different combinations and iterations trying to break the program<br/>
<br/>
Run<br/>
<img src="image 7.png"/><br/>
<br/>
You can see that it started fuzzing for STATS but program doesn't break as shown in immunity debugger<br/>
<br/>
Similarly we'll do for next commands<br/>
Let's do on TRUN command<br/>
<br/>
<img src="image 8.png"/><br/>
<br/>
Now if we again run the generic_send_tcp command<br/>
<br/>
This time in immunity debugger we'll see<br/>
<img src="image 9.png"/><br/>
<br/>
And in registers<br/>
<br/>
We see hex code of A in EIP<br/>
<br/>
<img src="image 10.png"/><br/>
<br/>
therefore by spiking we found the vulnerable pogram<br/>
<br/>
<span style="background-color: #ffff99">Finding</span>: TRUN is vulnerable<hr/><br/>
</span><b><span style="font-size: 15pt">2) Fuzzing<br/>
<br/>
</span></b><span style="font-size: 12pt">Again re-run the immunity debugger and vulnserver and attach the PID<br/>
<br/>
We'll create a python Script<br/>
<br/>
<img src="image 12.png"/><br/>
<br/>
Make it executable<br/>
<br/>
Now we'll execute it<br/>
<br/>
./1.py<br/>
<br/>
And the vuln server screen will look like this<br/>
<img height="305" src="image 14.png" width="300"/> <br/>
<br/>
We will see this on immunity debugger after sometime<br/>
<br/>
<img src="image 15.png"/><br/>
<br/>
Now Ctrl+C on the script<br/>
<br/>
It'll return an address<br/>
<img src="image 16.png"/><br/>
<br/>
<span style="background-color: #ffff99">Finding</span>: We'll round it up to 3000 and consider it as a byte size and in between the server crashed (Approximate position)<br/>
<hr/><br/>
Now what we'll do is create a 3000 byte length serial data and send it to buffer then we'll see what value is at EIP and will check where that value exist in serial data we created<br/>
<hr/></span><b><span style="font-size: 15pt"><br/>
</span><span style="font-size: 15pt">3) </span><span style="font-size: 13pt">Finding the offset         //To find where we break the program<br/>
</span><span style="font-size: 13pt"><br/>
</span></b><span style="font-size: 13pt">Metasploit provides us the tool to create that length of Serial code<b><br/>
</b></span><span style="font-size: 12pt"><br/>
<img src="image 11.png"/>---&gt;<img height="135" src="image 13.png" width="400"/><br/>
<br/>
Copy the string<br/>
<br/>
<img height="227" src="image 17.png" width="600"/><br/>
<br/>
Now give the executable permission and run<br/>
We'll see that immunity debugger again crashed and note down the contents of EIP<br/>
Its basically a HEX code<br/>
<img src="image 18.png"/><br/>
<br/>
Run the command to get the address of the contents present in EIP<br/>
<br/>
<img src="image 19.png"/><br/>
<br/>
<span style="background-color: #ffff99">Finding:</span><span style="background-color: #ffffff"> We exactly know that after 2003 bytes data moves in EIP section.<br/>
</span><span style="background-color: #ffffff">that is with 2003 bytes we can control EIP<br/>
<br/>
</span><span style="background-color: #ffffff">Now let's try to fill EIP with our desired data and test it</span><hr/></span><b><span style="font-size: 15pt"><br/>
</span><span style="font-size: 15pt">4) </span><span style="font-size: 13pt">Overwrite the EIP<br/>
</span></b><span style="background-color: #ffffff"><span style="font-size: 12pt"><br/>
</span></span><span style="font-size: 12pt"><span style="background-color: #ffffff">We </span>discovered that their are 2003 bytes right before EIP and EIP itself is of 4bytes(Since hexadecimal)<br/>
So, let's try to overwrite those 4 specific bytes<br/>
<br/>
Lets do changes in script<br/>
<br/>
<img src="image 20.png"/><br/>
<br/>
Make it executable and run it<br/>
<br/>
We should see 42424242 in EIP<br/>
<img src="image 21.png"/><br/>
<br/>
As 42 represents B<br/>
<br/>
<span style="background-color: #ffff99">Finding</span>: We are able to overwrite the EIP and sure with address 2003<br/>
<hr/><br/>
</span><b><span style="font-size: 15pt">5) </span><span style="font-size: 13pt">Finding Bad Characters<br/>
</span><span style="font-size: 13pt"><br/>
</span></b><span style="font-size: 12pt">When we generate the shell code we need to see what characters are good for shell code and what are bad<br/>
<br/>
</span><span style="font-size: 12pt">Go to : </span><a href="https://bulbsecurity.com/finding-bad-characters-with-immunity-debugger-and-mona-py/">https://bulbsecurity.com/finding-bad-characters-with-immunity-debugger-and-mona-py/</a><span style="font-size: 12pt"> <br/>
</span><span style="font-size: 12pt"><br/>
Copy the bad chars<br/>
<img height="117" src="image 23.png" width="550"/><br/>
</span><span style="font-size: 13pt"><b><br/>
<br/>
</b></span><span style="font-size: 12pt">Edit the python script<br/>
</span><span style="font-size: 13pt">remove \x00 from script<br/>
<br/>
here let's say \x07 do some task when choosen so we can't use it to create a shellcode. So to check it well send all these characters and check which misbehaves/abnormal<b><br/>
</b><b><img height="320" src="image 22.png" width="750"/><br/>
</b></span><span style="font-size: 12pt"><br/>
execute the script<br/>
<br/>
The immunity debugger will crash<br/>
<br/>
Goto ESP (Numeric Value)-&gt;Follow in Dump<br/>
<img src="image 24.png"/><br/>
<br/>
And check if any bad char is out of its place. Check till FF<br/>
<br/>
<img src="image 25.png"/> In this case no char is out of it's place. <br/>
<br/>
If there were a bad character then it would be out of its place.<br/>
For Ex:<br/>
<img src="image 26.png"/><br/>
So if we get a badcharacter then what to do?<br/>
Note them down as we'll use then while generating the shell code<br/>
<br/>
<span style="background-color: #ffff99">Finding</span>: No bad characters were found<hr/><br/>
</span><span style="font-size: 15pt"><b>5) </b></span><b><span style="font-size: 13pt">Finding the right module</span></b><span style="font-size: 12pt"><br/>
</span><span style="font-size: 12pt"><br/>
Here we mean that to find the dll or something similar inside the program(Vulnserver) which has no memory protection.<br/>
<br/>
To find that we'll use Monomodule with Immunity debugger<br/>
<br/>
</span><span style="font-size: 12pt">For monomodule Visit: </span><a href="https://github.com/corelan/mona">https://github.com/corelan/mona</a> <br/>
<br/>
<span style="font-size: 12pt">Download it and paste the mona.py in path<br/>
<b>C:\Program Files (x86)\Immunity Inc\Immunity Debugger\PyCommands</b><br/>
<br/>
<img height="287" src="image 27.png" width="500"/><br/>
<br/>
In immunity debugger<br/>
type <br/>
<br/>
<img src="image 28.png"/><br/>
<br/>
<img src="image 29.png"/><br/>
<br/>
So first one is our prime candidate<br/>
<br/>
Now lets find the opcode eqivalent of jump(Converting assembly language to hex code)<br/>
<br/>
<img src="image 30.png"/><br/>
<br/>
<img src="image 31.png"/><br/>
<br/>
<br/>
<img src="image 32.png"/><br/>
<br/>
So well try each return address<br/>
<br/>
<br/>
<img src="image 33.png"/><br/>
<br/>
<br/>
In paused mode<br/>
<br/>
<img src="image 34.png"/><br/>
<br/>
<br/>
<img src="image 35.png"/><br/>
Click on line an dpress F2 and then play<br/>
<br/>
Run the script<br/>
<br/>
Immunity debugger Ceashed<br/>
<br/>
W are able to control EIP <br/>
<img src="image 36.png"/>      <img src="image 37.png"/><br/>
<br/>
Finding: We are able to control EIP (As we jumped it to 625011af address) now we just need to generate some shell code and point directly to shell code<br/>
<br/>
<br/>
<br/>
</span><b><span style="font-size: 13pt"><br/>
</span></b><b><span style="font-size: 13pt"> </span></b><span style="font-size: 12pt"><br/>
</span><b><span style="font-size: 15pt"><br/>
</span></b></body></html>